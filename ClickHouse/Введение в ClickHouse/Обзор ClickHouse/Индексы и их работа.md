## Индексы в ClickHouse и их работа

ClickHouse использует уникальную систему индексов, которая оптимизирована для работы с большими объемами данных и быстрого выполнения аналитических запросов. Основные типы индексов в ClickHouse включают первичный индекс и вторичные индексы, каждый из которых имеет свои особенности и предназначение.

### Первичный индекс

1. **Структура**:
   - Первичный индекс в ClickHouse основан на первичном ключе таблицы и представляет собой **разреженный индекс**. Это означает, что он не индексирует каждую строку, а создает одну запись индекса на группу строк (гранулу), обычно состоящую из 8192 строк[1][2]. 
   - Каждая запись индекса содержит минимальное и максимальное значение для заданного диапазона строк, что позволяет быстро определять, какие гранулы могут содержать соответствующие данные.

2. **Функционирование**:
   - При выполнении запроса ClickHouse использует двоичный поиск по меткам индекса (marks) для определения, какие гранулы нужно обрабатывать[2][3]. Это значительно ускоряет выполнение запросов, особенно при фильтрации по первичному ключу.
   - Если запрос фильтрует данные по первичному ключу, ClickHouse может быстро идентифицировать необходимые гранулы и передать их на дальнейшую обработку[1][4].

3. **Сортировка данных**:
   - Данные в таблице физически упорядочены по значению первичного ключа, что позволяет эффективно использовать индексы при выполнении запросов диапазона[3]. Это также улучшает производительность вставок, так как данные записываются последовательно.

### Вторичные индексы

ClickHouse также поддерживает вторичные индексы, которые могут быть добавлены для улучшения производительности запросов по другим столбцам:

- **Объявление вторичных индексов**: Вторичные индексы могут быть созданы с помощью конструкции `CREATE TABLE`, где указываются дополнительные колонки для индексации[4]. Например:

```sql
CREATE TABLE products_views (
    date Date,
    product_id UInt32,
    product_name String,
    product_category UInt8
) ENGINE = MergeTree(date, (product_id), 8192);
```

- **Использование**: Вторичные индексы полезны для ускорения запросов, которые не могут быть оптимизированы с помощью первичного ключа. Однако они не обеспечивают уникальности значений и могут использоваться только для фильтрации по указанным столбцам[5].

### Эффективность использования индексов

- **Оптимизация запросов**: ClickHouse анализирует запросы и определяет, может ли использоваться индекс. Это происходит при наличии операторов фильтрации (например, `WHERE`, `IN`) на столбцах, входящих в первичный ключ[2][4].
- **Логирование использования индексов**: В логах запросов можно проверить, использует ли ClickHouse индексы при выполнении запросов. Например:

```bash
tail -f /var/log/clickhouse-server/clickhouse-server.log
```

При этом можно увидеть сообщения о том, какие условия были применены к индексам.

### Заключение

Индексы в ClickHouse играют ключевую роль в обеспечении высокой производительности работы с данными. Первичный индекс обеспечивает быструю выборку данных за счет разреженной индексации и упорядочивания по ключу, в то время как вторичные индексы позволяют оптимизировать доступ к данным по другим критериям. Правильная настройка и использование этих индексов критически важны для достижения максимальной эффективности работы с аналитическими запросами в ClickHouse.

Citations:
[1] https://ivan-shamaev.ru/clickhouse-101-course-on-learn-clickhouse-com/
[2] https://bigdataschool.ru/blog/news/clickhouse/indexes-in-clickhouse.html
[3] https://habr.com/ru/articles/509540/
[4] https://alexandrnikolaev.ru/blog/objavlenie-indeksov-v-clickhouse/
[5] https://www.youtube.com/watch?v=DJSYu_1yTdM
[6] https://habr.com/ru/companies/otus/articles/773174/
[7] https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree
[8] https://habr.com/ru/articles/539538/