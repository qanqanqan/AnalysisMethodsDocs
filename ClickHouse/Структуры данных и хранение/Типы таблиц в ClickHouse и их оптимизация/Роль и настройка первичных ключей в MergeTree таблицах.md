Первичные ключи (PRIMARY KEY) в таблицах, использующих движок MergeTree в ClickHouse, играют важную роль в определении порядка хранения данных и оптимизации выполнения запросов. Они влияют на то, как ClickHouse выполняет слияние (merge) данных, индексацию и выборку. Рассмотрим подробнее их роль и настройки.

### Роль первичных ключей в MergeTree таблицах

1. Упорядочивание данных:
- Первичный ключ определяет порядок, в котором данные хранятся в таблице. Это упорядочивание помогает ускорить выборку данных, особенно при использовании фильтров и диапазонов по первичному ключу.

2. Индексация:
- ClickHouse создает индекс по первичному ключу, что позволяет быстро находить записи, удовлетворяющие условиям запроса. Индекс позволяет минимизировать количество считываний данных с диска.

3. Оптимизация слияния (merge):
- При слиянии таблиц ClickHouse обрабатывает записи, основываясь на первичном ключе. Это позволяет эффективно обновлять данные и поддерживать актуальные агрегированные значения.

4. Уникальность:
- Важно понимать, что в ClickHouse уникальность по первичному ключу не является строгой. Записи с одинаковыми значениями первичного ключа допускаются и могут сливаться в процессе, если используется подходящий тип движка, например, ReplacingMergeTree.

### Настройка первичных ключей

1. Определение первичного ключа:
- При создании таблицы вы можете указать первичный ключ с помощью ключевого слова ORDER BY. Например:
```sql
CREATE TABLE example (
         id UInt32,
         timestamp DateTime,
         value Float32
     ) ENGINE = MergeTree()
     ORDER BY (id, timestamp);
```

2. Выбор полей для первичного ключа:
- Подбор полей для использования в первичном ключе должен быть основан на типичных запросах. Часто используемые в фильтрах и группировках поля должны входить в первичный ключ. Это значительно повышает производительность запросов.

3. Адекватный размер первичного ключа:
- Поля, входящие в первичный ключ, должны быть достаточного размера, чтобы обеспечить оптимизацию, но не слишком большими, чтобы избежать увеличения размера индекса. Выбор подходящих типов данных имеет значение.

4. Изменение первичного ключа:
- После создания таблицы нельзя изменить первичный ключ напрямую. Для изменения необходимо создать новую таблицу и перенести данные. Например:
```sql
CREATE TABLE new_example (
         id UInt32,
         timestamp DateTime,
         value Float32
     ) ENGINE = MergeTree()
     ORDER BY (timestamp, id);

INSERT INTO new_example SELECT * FROM example;
```

5. Разграничение по партициям:
- В дополнение к первичному ключу, можно использовать партиционирование (PARTITION BY) для разграничения данных, что также может значительно повысить эффективность обработки и выборки данных.

