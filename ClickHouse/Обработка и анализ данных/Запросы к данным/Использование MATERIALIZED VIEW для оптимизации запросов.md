### Использование MATERIALIZED VIEW для оптимизации запросов в ClickHouse

**Материализованные представления** (MATERIALIZED VIEW) в ClickHouse представляют собой мощный инструмент для оптимизации производительности запросов, позволяя выполнять вычисления во время вставки данных, а не при выполнении запросов. Это позволяет значительно сократить время выполнения запросов и улучшить общую эффективность работы с данными.

## Основные характеристики MATERIALIZED VIEW

1. **Автоматическое обновление**: Материализованные представления обновляются автоматически при вставке новых данных в базовую таблицу. Это означает, что результаты агрегирования или преобразования данных всегда актуальны.

2. **Снижение нагрузки на запросы**: Поскольку материализованные представления хранят предварительно вычисленные результаты, они позволяют избежать повторных вычислений при выполнении запросов, что значительно ускоряет их выполнение.

3. **Поддержка агрегации и фильтрации**: Вы можете использовать материализованные представления для выполнения различных типов агрегаций (например, суммы, среднего, максимума) и фильтрации данных перед их сохранением в целевой таблице.

## Пример использования MATERIALIZED VIEW

### Создание базовой таблицы

Предположим, у вас есть таблица `sales`, которая хранит информацию о продажах:

```sql
CREATE TABLE sales (
    product_id UInt32,
    sale_amount Float32,
    sale_date DateTime
) ENGINE = MergeTree()
ORDER BY sale_date;
```

### Создание целевой таблицы

Создайте целевую таблицу, куда будут записываться результаты агрегирования:

```sql
CREATE TABLE daily_sales (
    product_id UInt32,
    total_sales Float32
) ENGINE = SummingMergeTree()
ORDER BY product_id;
```

### Создание материализованного представления

Теперь создайте материализованное представление, которое будет агрегировать данные по дням и записывать результаты в целевую таблицу:

```sql
CREATE MATERIALIZED VIEW mv_daily_sales 
TO daily_sales AS 
SELECT 
    product_id,
    SUM(sale_amount) AS total_sales
FROM 
    sales
GROUP BY 
    product_id, 
    toStartOfDay(sale_date);
```

В этом примере материализованное представление `mv_daily_sales` будет автоматически обновляться при вставке новых данных в таблицу `sales`, агрегируя суммы продаж по каждому продукту за день.

### Вставка данных и проверка результатов

После создания материализованного представления вы можете вставить данные в базовую таблицу:

```sql
INSERT INTO sales (product_id, sale_amount, sale_date) VALUES 
(1, 100.0, '2024-01-01 10:00:00'),
(1, 150.0, '2024-01-01 12:00:00'),
(2, 200.0, '2024-01-01 14:00:00');
```

Теперь вы можете проверить результаты в целевой таблице `daily_sales`:

```sql
SELECT * FROM daily_sales;
```

Этот запрос вернет агрегированные данные о продажах за день для каждого продукта.

## Заключение

Использование **материализованных представлений** в ClickHouse позволяет значительно оптимизировать выполнение запросов за счет автоматического обновления агрегированных данных во время вставки. Это снижает нагрузку на систему и ускоряет доступ к данным, что делает ClickHouse эффективным инструментом для аналитических задач в реальном времени.

Citations:
[1] https://clickhouse.com/docs/en/materialized-view
[2] https://www.youtube.com/watch?v=QUigKP7iy7Y
[3] https://clickhouse.com/blog/using-materialized-views-in-clickhouse
[4] https://kb.altinity.com/altinity-kb-schema-design/materialized-views/
[5] https://bigdataschool.ru/blog/news/clickhouse/views-in-clickhouse.html
[6] https://habr.com/ru/articles/657579/
[7] https://juicefs.com/en/blog/solutions/clickhouse-disaggregated-storage-and-compute-practice
[8] https://clickhouse.com/docs/en/sql-reference/statements/select/group-by