В ClickHouse подзапросы могут быть использованы для фильтрации данных, что позволяет более гибко и эффективно извлекать нужную информацию из больших наборов данных. Подзапросы могут быть встроены в основные запросы, используя операторы `IN`, `EXISTS`, или как часть выражений в `WHERE`. Давайте рассмотрим, как это работает.

### Основные способы использования подзапросов для фильтрации

1. **Использование оператора IN**

Оператор `IN` позволяет проверить, содержится ли значение в наборе результатов подзапроса. Это особенно полезно, когда нужно фильтровать данные на основе значений из другой таблицы.

#### Пример

Предположим, у вас есть две таблицы: `sales` и `products`. Вы хотите получить все продажи для продуктов, которые находятся в определенном списке.

```sql
SELECT *
FROM sales
WHERE product_id IN (SELECT id FROM products WHERE category = 'Electronics');
```

В этом примере подзапрос выбирает идентификаторы продуктов из таблицы `products`, которые принадлежат категории "Электроника", и основной запрос фильтрует записи в таблице `sales` на основе этих идентификаторов.

2. **Использование EXISTS**

Оператор `EXISTS` позволяет проверить, существуют ли записи, удовлетворяющие условиям подзапроса. Это может быть полезно для более сложных условий фильтрации.

#### Пример

```sql
SELECT *
FROM sales s
WHERE EXISTS (
    SELECT 1 
    FROM products p 
    WHERE p.id = s.product_id AND p.category = 'Electronics'
);
```

Этот запрос возвращает все записи из таблицы `sales`, для которых существует соответствующая запись в таблице `products` с категорией "Электроника".

3. **Фильтрация с использованием JOIN**

Хотя это не совсем подзапрос, использование оператора `JOIN` также позволяет фильтровать данные на основе связанных записей в других таблицах.

#### Пример

```sql
SELECT s.*
FROM sales s
JOIN products p ON s.product_id = p.id
WHERE p.category = 'Electronics';
```

Этот запрос возвращает все продажи для продуктов из категории "Электроника", используя явное соединение между таблицами.

### Оптимизация запросов с подзапросами

ClickHouse поддерживает оптимизацию выполнения запросов с подзапросами, что может значительно ускорить выполнение сложных запросов. Например, использование параметра `GLOBAL IN` вместо обычного `IN` может помочь избежать проблем с производительностью при работе с распределенными таблицами.

#### Пример использования GLOBAL IN

```sql
SELECT uniq(UserID) 
FROM distributed_table 
WHERE CounterID = 101500 
AND UserID GLOBAL IN (SELECT UserID FROM distributed_table WHERE CounterID = 34);
```

Этот запрос будет отправлен на все удаленные серверы и выполнен параллельно, что улучшает производительность по сравнению с обычным `IN`.

### Заключение

Использование подзапросов для фильтрации данных в ClickHouse позволяет создавать более сложные и мощные SQL-запросы. Операторы `IN` и `EXISTS`, а также использование соединений позволяют эффективно извлекать нужные данные из различных таблиц. Оптимизация выполнения запросов с помощью параметров, таких как `GLOBAL IN`, также может значительно повысить производительность при работе с большими объемами данных.

Citations:
[1] https://presentations.clickhouse.com/hse_2020/3rd/ProbablisticFilters_pres.pdf
[2] https://clickhouse.com/docs/ru/sql-reference/statements/select/where
[3] https://clickhouse.com/docs/ru/sql-reference/operators/in
[4] https://habr.com/ru/articles/743772/
[5] https://clickhouse.com/docs/ru/operations/settings/settings
[6] https://bigdataschool.ru/blog/news/clickhouse/clickhouse-final-in-select-query.html
[7] https://ru.stackoverflow.com/questions/1278732/clickhouse-%D0%B0%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8-%D0%BF%D0%BE%D0%B4%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2
[8] https://bigdataschool.ru/blog/news/clickhouse/views-in-clickhouse.html