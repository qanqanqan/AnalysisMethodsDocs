## Консистентность данных в ZooKeeper

Apache ZooKeeper обеспечивает высокую степень консистентности данных в распределенных системах, используя модель, известную как **сильная консистентность**. Это означает, что все клиенты видят одни и те же данные в один и тот же момент времени, даже если они подключены к разным серверам в кластере ZooKeeper. Вот основные механизмы и концепции, которые обеспечивают консистентность данных в ZooKeeper:

### Основные механизмы консистентности

1. **Atomicity (Атомарность)**:
   - Все операции записи в ZooKeeper являются атомарными. Это означает, что они либо полностью завершаются, либо не выполняются вовсе, что предотвращает частичные обновления данных.

2. **Sequential Consistency (Последовательная консистентность)**:
   - Операции, выполняемые клиентами, применяются в том же порядке, в каком они были отправлены. Это гарантирует, что все клиенты видят изменения в одном и том же порядке.

3. **Single System Image (Единое представление системы)**:
   - Независимо от того, к какому серверу ZooKeeper подключен клиент, он всегда видит одно и то же представление данных. Это достигается за счет согласованности данных между серверами.

4. **Durability (Долговечность)**:
   - После подтверждения выполнения операции данные гарантированно сохраняются, даже в случае сбоя сервера. Это обеспечивается за счет записи данных в журнал транзакций.

5. **Leader Election (Выбор лидера)**:
   - В ZooKeeper используется алгоритм выбора лидера для координации всех операций записи. Лидер отвечает за обработку всех запросов на запись и их распространение на другие серверы (реплики). Это гарантирует, что все изменения данных проходят через один узел, поддерживая консистентность.

### Протокол ZAB

ZooKeeper использует протокол **ZAB (ZooKeeper Atomic Broadcast)** для обеспечения надежной передачи и согласованности данных между серверами. Основные функции ZAB:

- **Broadcast (Широковещание)**: Лидер посылает изменения данных всем последователям (follower) в кластере.
- **Synchronization (Синхронизация)**: Перед тем как стать активным, новый лидер должен синхронизироваться с большинством серверов, чтобы гарантировать, что у него самая последняя версия данных.
- **Crash Recovery (Восстановление после сбоев)**: В случае сбоя лидера новый лидер выбирается, и система продолжает работать без потери данных.

### Гарантии консистентности

ZooKeeper предоставляет следующие гарантии консистентности:

- **Linearizability (Линеаризуемость)**: Все операции записи линейно упорядочены и видны всем клиентам в одном и том же порядке.
- **FIFO Client Order (Порядок FIFO для клиентов)**: Операции от каждого конкретного клиента обрабатываются в порядке их отправки.

Эти механизмы и протоколы делают ZooKeeper надежным выбором для управления состоянием и координацией в распределенных системах, обеспечивая высокую степень консистентности данных.