Safe Mode (безопасный режим) — это специальное состояние HDFS, при котором файловая система доступна только для чтения. В этом режиме не разрешаются операции записи или изменения данных, а сама система ожидает подтверждения, что достаточное количество блоков данных доступно и реплицировано на всех узлах DataNode.

# Назначение Safe Mode

Safe Mode нужен для защиты файловой системы при запуске кластера или после сбоя. Это состояние временно активируется NameNode и имеет несколько ключевых целей:

## Проверка целостности данных:

- При запуске HDFS или восстановлении после сбоя NameNode должен убедиться, что большинство блоков данных имеют необходимое количество реплик. Safe Mode используется для того, чтобы предотвратить работу с файлами, пока не будет подтверждено, что система в стабильном состоянии и большинство данных доступны.

## Ожидание отчетов от DataNode:

- После запуска кластера NameNode собирает отчеты о блоках от всех узлов DataNode (block reports), чтобы убедиться, что каждый блок данных реплицирован в соответствии с установленной политикой репликации. Safe Mode сохраняется, пока NameNode не получит информацию о достаточном количестве блоков.

## Защита от потери данных:

- Пока кластер находится в Safe Mode, любые операции записи или удаления данных запрещены. Это предотвращает случайные изменения в данных до того, как система удостоверится в наличии всех необходимых блоков.

## Репликация недостающих блоков:

- Если после выхода из Safe Mode обнаруживается, что некоторые блоки имеют недостаточное количество реплик, HDFS начинает процесс репликации этих блоков.

# Как работает Safe Mode

Когда HDFS переходит в Safe Mode, NameNode начинает подсчитывать количество реплик для каждого блока. Safe Mode продолжается до тех пор, пока не будут выполнены следующие условия:

1. Минимальный процент реплик:

    - По умолчанию HDFS ждет, пока определённый процент всех блоков будет реплицирован в необходимом количестве (по умолчанию — 99.9%). Этот процент можно изменить с помощью параметра dfs.namenode.safemode.threshold-pct.
2. Минимальное количество блоков:

    - Параметр dfs.namenode.safemode.min.datanodes определяет минимальное количество узлов DataNode, которые должны отправить отчет о блоках, прежде чем NameNode выйдет из Safe Mode.
3. Таймаут выхода из Safe Mode:

    - Иногда даже при наличии всех необходимых блоков NameNode может остаться в Safe Mode дольше необходимого. В таких случаях можно вручную вывести NameNode из Safe Mode (об этом позже).

# Использование Safe Mode

Safe Mode обычно активируется автоматически при запуске кластера, но можно управлять им вручную с помощью команд или конфигураций. Это может понадобиться в случаях, когда требуется диагностировать состояние кластера или выполнить обслуживание.

## Команды для работы с Safe Mode:
1. Включение Safe Mode вручную:

    - Для того чтобы вручную ввести NameNode в Safe Mode, используется следующая команда:
```linux
hdfs dfsadmin -safemode enter
```
    - Это переводит NameNode в режим, при котором все операции записи данных блокируются.

2. Выход из Safe Mode:

    - Чтобы вручную вывести кластер из Safe Mode, используется команда:
```linux
hdfs dfsadmin -safemode leave
```
    - NameNode выходит из Safe Mode, и операции записи снова разрешены.

3. Проверка текущего состояния Safe Mode:

    - Чтобы узнать, находится ли HDFS в Safe Mode, можно использовать команду:
```linux
hdfs dfsadmin -safemode get
```

## Автоматический выход из Safe Mode

Когда NameNode получает достаточное количество отчетов о блоках от DataNode и убеждается, что все или почти все блоки данных имеют необходимое количество реплик, он автоматически выходит из Safe Mode.

# Конфигурационные параметры Safe Mode

Некоторые параметры, касающиеся Safe Mode, можно настроить в файле hdfs-site.xml:

1. dfs.namenode.safemode.threshold-pct:

    - Определяет процент блоков, которые должны быть реплицированы, чтобы NameNode мог выйти из Safe Mode.
    - Пример настройки:
```xml
<property>
  <name>dfs.namenode.safemode.threshold-pct</name>
  <value>0.999</value>
</property>
```
 По умолчанию — 99.9% блоков должны быть реплицированы.

2. dfs.namenode.safemode.min.datanodes:

    - Определяет минимальное количество DataNode, которые должны быть активными, чтобы NameNode мог выйти из Safe Mode.
Пример:
```xml
<property>
  <name>dfs.namenode.safemode.min.datanodes</name>
  <value>1</value>
</property>
```

3. dfs.safemode.extension:

    - Задает дополнительное время в миллисекундах, в течение которого NameNode остается в Safe Mode после достижения порога репликации. Это может быть полезно для того, чтобы система стабилизировалась перед выходом из Safe Mode.
    - Пример:
```xml
<property>
  <name>dfs.safemode.extension</name>
  <value>30000</value> <!-- 30 секунд -->
</property>
```

# Пример сценария использования Safe Mode:
1. Перезагрузка кластера:

    - При перезапуске кластера Hadoop NameNode переходит в Safe Mode и начинает получать отчеты от DataNode. В это время операции записи блокируются, чтобы избежать некорректных изменений.
2. Аварийное восстановление:

    - После аварийного завершения работы или сбоя NameNode проверяет целостность данных в Safe Mode. Если некоторые блоки утрачены, система восстанавливает недостающие реплики перед тем, как выйти из Safe Mode.
3. Обслуживание кластера:

    - Администраторы могут вручную включить Safe Mode, если требуется провести диагностику или обслуживание кластера без риска потери данных.
# Вывод

Safe Mode — это важный механизм HDFS, который обеспечивает целостность и защиту данных во время критических операций, таких как запуск или восстановление системы. Он предотвращает любые операции записи до тех пор, пока NameNode не удостоверится, что система находится в стабильном состоянии.