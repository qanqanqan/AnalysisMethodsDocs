# Управление метаданными и 'сердцебиение' в HDFS

Hadoop Distributed File System (HDFS) является распределенной файловой системой, которая управляет большими объемами данных на множестве узлов. Для обеспечения надежности и эффективной работы системы необходимо эффективно управлять метаданными и взаимодействием между узлами. В HDFS ключевую роль в управлении метаданными играет NameNode, а для мониторинга состояния узлов используется механизм 'сердцебиения' (heartbeat). Этот документ описывает роль NameNode, управление метаданными и механизм 'сердцебиения' в HDFS.

## 1. Управление метаданными в HDFS

### 1.1. Роль NameNode

**NameNode** является центральным компонентом HDFS и отвечает за управление метаданными файловой системы. Метаданные содержат информацию о:

- Именах файлов и каталогов.
- Структуре каталогов.
- Расположении блоков данных на узлах DataNode.
- Факторах репликации блоков.

Фактические данные хранятся на узлах DataNode, а NameNode хранит только метаданные о том, какие блоки данных соответствуют каждому файлу и на каких узлах эти блоки находятся.

### 1.2. Хранение метаданных

Метаданные в HDFS включают следующие компоненты:

- **Namespace Image (FsImage)**: Это снимок состояния файловой системы на определенный момент времени. FsImage хранит информацию обо всех файлах, каталогах и блоках данных в HDFS.
- **Edit Logs**: Журнал всех изменений файловой системы (создание, удаление, изменение файлов и каталогов). Edit Logs записывают все операции после последнего снимка (FsImage).

### 1.3. Обновление метаданных

Каждая операция записи (создание файла, удаление, изменение) фиксируется в **Edit Logs**. На регулярной основе NameNode объединяет Edit Logs и FsImage для создания нового снимка состояния файловой системы. Этот процесс называется **компактизацией** (checkpointing).

- **FsImage** загружается в оперативную память NameNode для обеспечения высокой скорости работы.
- Все операции с метаданными выполняются в памяти, что позволяет NameNode быстро отвечать на запросы клиентов.

### 1.4. Управление отказами метаданных

Чтобы предотвратить потерю метаданных, HDFS использует несколько уровней защиты:

- **Репликация метаданных**: Метаданные NameNode могут быть реплицированы на резервные узлы с использованием Secondary NameNode или режима высокой доступности (High Availability).
- **Quorum Journal Manager (QJM)**: В режиме HA журналы операций (Edit Logs) реплицируются на нескольких узлах для предотвращения потери данных при сбое.

## 2. Механизм 'сердцебиения' (heartbeat)

### 2.1. Что такое 'сердцебиение'?

'Сердцебиение' (heartbeat) — это периодический сигнал, отправляемый узлами DataNode на NameNode для информирования о том, что узел работает и доступен. Этот механизм используется для мониторинга состояния всех узлов DataNode в кластере.

- **Интервал 'сердцебиения'**: DataNode отправляют сигнал 'сердцебиения' на NameNode каждые несколько секунд (обычно 3 секунды).
- Если 'сердцебиение' от DataNode не поступает в течение определенного времени (по умолчанию 10 минут), NameNode считает, что DataNode вышел из строя.

### 2.2. Важность 'сердцебиения'

'Сердцебиение' выполняет следующие ключевые функции:

- **Мониторинг работоспособности DataNode**: NameNode использует сигналы 'сердцебиения' для отслеживания состояния всех DataNode в кластере. Если узел DataNode перестает отправлять 'сердцебиение', NameNode помечает его как недоступный и инициирует процессы восстановления.
- **Обмен информацией**: Вместе с сигналом 'сердцебиения' DataNode отправляют на NameNode отчеты о состоянии дисков, занятости блоков и прогрессе операций. Это позволяет NameNode принимать решения о размещении блоков и инициировать репликацию данных на другие узлы.

### 2.3. Восстановление после отказа DataNode

Когда NameNode обнаруживает, что DataNode перестал отправлять 'сердцебиение', он помечает этот узел как "мертвый" и начинает процесс восстановления:

1. **Отключение узла**: NameNode помечает все блоки данных на недоступном DataNode как "недостающие".
2. **Репликация данных**: NameNode создает новые реплики недостающих блоков на других DataNode для восстановления необходимого фактора репликации.
3. **Удаление старых данных**: Когда DataNode снова становится доступным, если блоки данных на нем больше не нужны, HDFS автоматически удаляет их, чтобы избежать избыточного использования пространства.

### 2.4. Передача блоков

С помощью механизма 'сердцебиения' NameNode может отправлять DataNode команды на передачу блоков данных. Это используется, например, в следующих случаях:

- **Репликация данных**: Если необходимо создать дополнительные копии блока, NameNode может отправить команду DataNode передать блок другим узлам.
- **Балансировка данных**: Когда данные на узле DataNode становятся слишком загруженными, NameNode может инициировать процесс балансировки, перемещая блоки на менее загруженные узлы.

## 3. Обработка отчетов о блоках (Block Reports)

### 3.1. Назначение отчетов о блоках

DataNode периодически отправляют NameNode **отчеты о блоках (Block Reports)**. В этих отчетах содержится информация обо всех блоках данных, которые хранятся на конкретном DataNode. Отчеты о блоках позволяют NameNode отслеживать, какие блоки хранятся на каждом узле и какие реплики блоков доступны.

### 3.2. Обработка отчетов о блоках

- **Периодичность**: DataNode отправляют отчеты о блоках примерно раз в час.
- **Использование информации**: NameNode использует эти отчеты для:
  - Проверки целостности и наличия всех блоков данных.
  - Идентификации недостающих или избыточных блоков.
  - Принятия решений о репликации или удалении блоков.

## Заключение

Управление метаданными и механизм 'сердцебиения' в HDFS играют ключевую роль в обеспечении отказоустойчивости, надежности и производительности системы. NameNode управляет всеми метаданными файловой системы, такими как информация о блоках данных и их расположении. DataNode периодически отправляют 'сердцебиения' и отчеты о блоках для информирования NameNode о своем состоянии. Эти механизмы обеспечивают своевременное обнаружение сбоев и эффективное восстановление данных, гарантируя бесперебойную работу HDFS в распределенной среде.
