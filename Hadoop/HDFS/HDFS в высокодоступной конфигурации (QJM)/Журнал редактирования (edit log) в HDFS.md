# Журнал редактирования (Edit Log) в HDFS

**Журнал редактирования (Edit Log)** — это важный компонент в архитектуре **HDFS** (Hadoop Distributed File System), который отвечает за запись всех изменений, происходящих в файловой системе. Этот журнал служит для сохранения информации о каждой операции, которая изменяет состояние метаданных HDFS, таких как создание, удаление или изменение файлов. В данном документе описаны функции, структура и управление журналом редактирования в HDFS.

## 1. Назначение Edit Log

Основное назначение **Edit Log** — это запись последовательности изменений, которые происходят в HDFS. Эти изменения могут включать:

- Создание новых файлов или директорий.
- Удаление файлов или директорий.
- Изменение атрибутов файлов (например, прав доступа).
- Перемещение файлов между директориями.

Когда клиент выполняет операцию, которая изменяет состояние файловой системы, NameNode немедленно записывает эту операцию в журнал редактирования. Таким образом, Edit Log фиксирует каждое изменение в HDFS в строгой последовательности, что помогает восстановить точное состояние файловой системы в случае сбоя.

## 2. Структура и процесс записи в Edit Log

### 2.1. Формат записи

Edit Log представляет собой последовательный журнал, в который записываются все операции изменения файловой системы. Каждая запись в журнале содержит:
- Тип операции (например, создание, удаление, перемещение файла).
- Время операции.
- Параметры операции (например, путь к файлу или директории, права доступа и т.д.).

### 2.2. Процесс записи

Когда клиент выполняет операцию с файловой системой, происходит следующее:
1. **Запрос от клиента**: Клиент отправляет запрос на изменение (например, создание файла) в NameNode.
2. **Запись в Edit Log**: NameNode фиксирует это изменение в Edit Log до того, как выполнит операцию. Это делается для того, чтобы изменения не были потеряны в случае сбоя NameNode.
3. **Выполнение операции**: После записи в журнал NameNode обновляет состояние своих метаданных (в оперативной памяти) в соответствии с операцией.
4. **Ответ клиенту**: После успешного завершения операции NameNode отправляет клиенту подтверждение.

### 2.3. Хранение Edit Log

Журнал Edit Log хранится на локальном диске NameNode. Так как HDFS полагается на метаданные, которые управляются NameNode, сохранение этих изменений в журнале является критически важным для обеспечения целостности файловой системы.

## 3. Роль Edit Log в процессе восстановления

В случае сбоя NameNode журнал редактирования играет ключевую роль в восстановлении состояния файловой системы:

1. При перезапуске NameNode загружает последний сохраненный снимок состояния метаданных (**FsImage**), который содержит полное состояние файловой системы на момент последнего сохранения.
2. Затем NameNode воспроизводит все операции, записанные в Edit Log, чтобы восстановить текущее состояние файловой системы на момент сбоя.
   
Таким образом, восстановление после сбоя происходит путем применения всех изменений, записанных в Edit Log, к последнему снимку состояния (FsImage).

## 4. Проблема роста Edit Log

Со временем журнал Edit Log может значительно увеличиться в размере, так как каждое изменение файловой системы добавляется в журнал. Это приводит к следующим проблемам:
- **Замедление восстановления**: Чем больше Edit Log, тем дольше будет восстанавливаться NameNode после сбоя, так как необходимо воспроизвести все изменения.
- **Увеличение времени работы**: Большой объем данных в журнале может замедлять общую работу NameNode.

## 5. Управление Edit Log: Слияние с FsImage

Для решения проблемы роста журнала используется механизм слияния Edit Log и **FsImage**:

- **FsImage** — это снимок текущего состояния файловой системы, который представляет собой полную копию метаданных на момент создания снимка.
- В процессе слияния журнал изменений (Edit Log) и текущий снимок (FsImage) объединяются. Это позволяет очистить Edit Log и начать запись изменений в новый файл журнала.

Этот процесс слияния выполняется **Secondary NameNode** (или автоматически в конфигурации с высокой доступностью) и позволяет предотвратить бесконтрольный рост Edit Log, поддерживая баланс между объемом данных в журнале и быстродействием системы.

### Процесс слияния:

1. Secondary NameNode получает копии Edit Log и FsImage.
2. Все изменения из Edit Log применяются к FsImage, создавая новый актуальный снимок файловой системы.
3. NameNode получает новый снимок и начинает запись нового Edit Log.
   
Таким образом, система поддерживает актуальность данных и контролирует размер журнала изменений.

## 6. Периодичность создания новых Edit Log

Периодичность слияния Edit Log с FsImage и создания нового журнала зависит от конфигурации кластера HDFS. Обычно эта операция выполняется либо по расписанию (например, каждые несколько часов), либо по достижении определенного размера Edit Log.

## 7. Заключение

**Edit Log** является важным компонентом в системе HDFS, который отвечает за журналирование всех изменений в файловой системе. Он обеспечивает целостность данных и помогает восстановить состояние файловой системы в случае сбоя. Однако для предотвращения неконтролируемого роста журнала и повышения производительности используется регулярное слияние Edit Log с FsImage, что поддерживает систему в актуальном и стабильном состоянии.
