# Процесс Failover и роль Standby NameNode в HDFS

Failover — это процесс автоматического или ручного переключения между **Active NameNode** и **Standby NameNode** в HDFS с высокой доступностью (HA). Этот механизм обеспечивает непрерывную работу системы даже при сбое основного узла (Active NameNode).

## Роль Standby NameNode

**Standby NameNode** — это резервный узел, который синхронизируется с Active NameNode, но в обычных условиях не обрабатывает запросы клиентов. Его основная задача — поддерживать актуальное состояние файловой системы HDFS, чтобы в случае сбоя Active NameNode он мог быстро принять на себя роль ведущего узла (Active).

### Основные функции Standby NameNode:

1. **Чтение журналов изменений (edit logs)**:
   - Standby NameNode регулярно запрашивает журналы изменений у JournalNodes, чтобы обновлять своё состояние в соответствии с действиями, выполненными Active NameNode.
   
2. **Синхронизация с Active NameNode**:
   - Standby NameNode синхронизирует состояние файловой системы с Active NameNode. Он применяет все изменения, записанные в журналы (edit logs), чтобы поддерживать актуальность метаданных HDFS.

3. **Готовность к failover**:
   - В любой момент времени Standby NameNode готов к переключению в Active режим в случае сбоя основного узла. Для этого он отслеживает текущее состояние системы с помощью ZooKeeper и готовится к быстрому переходу.

## Процесс Failover

Failover может быть двух типов:
1. **Автоматический failover** — инициируется системой, если Active NameNode выходит из строя.
2. **Ручной failover** — выполняется администратором вручную через команду переключения в случае, если требуется обслуживание или обновление.

### Шаги процесса failover:

1. **Обнаружение сбоя Active NameNode**:
   - Служба **ZooKeeper** постоянно отслеживает состояние Active NameNode. Если ZooKeeper не может связаться с Active NameNode, он считает, что произошёл сбой.

2. **Инициация failover**:
   - ZooKeeper запускает процесс failover. Он уведомляет Standby NameNode о том, что тот должен стать новым Active NameNode.
   
3. **Применение последних изменений**:
   - Перед тем, как Standby NameNode становится Active, он завершает чтение всех журналов изменений (edit logs) от JournalNodes, чтобы его состояние файловой системы было полностью актуальным.

4. **Переход в режим Active**:
   - Standby NameNode переключается в режим Active, после чего он начинает обрабатывать запросы от клиентов на чтение и запись данных.
   - Новый Active NameNode продолжает использовать JournalNodes для записи изменений, обеспечивая высокую доступность.

5. **Уведомление системы**:
   - После успешного переключения новый Active NameNode уведомляет остальные компоненты системы (например, DataNodes), что теперь он является ведущим узлом.

6. **Продолжение работы системы**:
   - Клиенты и DataNodes начинают взаимодействовать с новым Active NameNode, и работа HDFS продолжается без значительных простоев.

### Защита от сплит-мозга (Split-Brain)

Во время процесса failover важно избежать ситуации, когда оба узла (и Active, и Standby) одновременно считаются ведущими. Для этого используется механизм кворума и синхронизация через ZooKeeper, который строго контролирует, какой узел является активным.

- Только один узел (тот, который ZooKeeper объявляет Active) может выполнять операции записи и взаимодействовать с клиентами.
- Система отслеживает кворум для предотвращения несогласованности данных.

## Преимущества failover и Standby NameNode

- **Непрерывность работы**: Процесс failover происходит быстро, сводя к минимуму простой системы.
- **Отказоустойчивость**: Даже в случае аппаратных сбоев или сбоя Active NameNode, Standby узел может взять на себя управление без потери данных.
- **Минимизация потерь данных**: Благодаря постоянной синхронизации между Active и Standby NameNode, все изменения в системе сохраняются, что позволяет избежать потерь данных при переключении.

