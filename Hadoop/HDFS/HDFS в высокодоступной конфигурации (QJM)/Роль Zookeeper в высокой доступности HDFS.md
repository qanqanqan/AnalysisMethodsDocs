# Роль ZooKeeper в высокой доступности HDFS

**ZooKeeper** — это централизованный сервис для управления конфигурацией и координации распределённых систем. В контексте HDFS с высокой доступностью (HA), ZooKeeper играет ключевую роль в управлении процессом переключения (failover) между **Active NameNode** и **Standby NameNode**, а также обеспечивает защиту от ситуации "split-brain" (сплит-мозг).

## Основные функции ZooKeeper в HDFS

1. **Мониторинг состояния NameNode**:
   - ZooKeeper постоянно отслеживает состояние как Active, так и Standby NameNode. Он используется для определения того, какой из узлов является активным (Active) и должен обслуживать запросы клиентов.
   
2. **Управление failover**:
   - При сбое Active NameNode, ZooKeeper автоматически инициирует процесс failover, назначая Standby NameNode в качестве нового Active. Это происходит быстро и с минимальными задержками, чтобы обеспечить непрерывную работу HDFS.
   
3. **Защита от split-brain**:
   - ZooKeeper предотвращает ситуацию, при которой оба NameNode (и Active, и Standby) могут считаться активными одновременно. Это обеспечивается путем строгого контроля над правом узла на выполнение операций записи. ZooKeeper гарантирует, что в каждый момент времени только один узел может быть активным.

## Как ZooKeeper работает в HDFS HA

### 1. **Мониторинг узлов (NameNode Monitoring)**:
   - Оба NameNode (Active и Standby) регистрируются в ZooKeeper и периодически отправляют ему "heartbeat" сигналы, сообщая о своем состоянии.
   - Если Active NameNode перестает отправлять сигналы, ZooKeeper фиксирует это как сбой.

### 2. **Выбор активного узла (Leader Election)**:
   - ZooKeeper используется для координации выбора Active NameNode. Он гарантирует, что только один NameNode обладает правами на выполнение операций записи в любой момент времени.
   - Когда происходит переключение (failover), ZooKeeper передает право быть Active узлу Standby NameNode, делая его новым ведущим узлом.

### 3. **Процесс failover**:
   - Когда ZooKeeper обнаруживает, что Active NameNode вышел из строя, он инициирует failover:
     1. ZooKeeper уведомляет Standby NameNode, что он должен стать новым Active NameNode.
     2. Standby NameNode завершает синхронизацию с журналами изменений (edit logs) через JournalNodes.
     3. Standby NameNode переключается в режим Active и начинает обрабатывать клиентские запросы.
   
### 4. **Защита от split-brain**:
   - Split-brain — это опасная ситуация, при которой оба NameNode могут одновременно считаться активными. Это может привести к потере данных или несогласованности системы.
   - ZooKeeper предотвращает split-brain, используя механизм блокировки с кворумом. Он гарантирует, что Standby NameNode станет Active только в том случае, если предыдущий Active узел потерял свои права на запись.

### 5. **Координация работы с JournalNodes**:
   - ZooKeeper координирует взаимодействие NameNode с JournalNodes, гарантируя, что все изменения в системе правильно синхронизируются между Active и Standby NameNode.

## Преимущества использования ZooKeeper в HDFS HA

1. **Автоматическое переключение**: ZooKeeper обеспечивает автоматическое и быстрое переключение (failover) между Active и Standby NameNode, минимизируя время простоя системы.
2. **Гарантия согласованности**: Использование ZooKeeper предотвращает split-brain и гарантирует, что в системе всегда будет только один активный NameNode.
3. **Высокая отказоустойчивость**: Благодаря постоянному мониторингу состояния узлов, ZooKeeper обеспечивает надёжную работу HDFS даже в случае сбоев оборудования или программного обеспечения.
4. **Минимизация потерь данных**: ZooKeeper помогает координировать синхронизацию данных между Active и Standby узлами, что позволяет избегать потерь данных при переключении.

## Заключение

ZooKeeper играет ключевую роль в обеспечении высокой доступности HDFS, выполняя функции мониторинга состояния NameNode, координации процесса failover и защиты от split-brain. Его использование делает HDFS отказоустойчивым и позволяет системе работать без значительных простоев даже при сбоях.

