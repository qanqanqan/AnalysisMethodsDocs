# Роль и работа Quorum Journal Manager (QJM) в HDFS

Quorum Journal Manager (QJM) — это компонент Hadoop HDFS, который отвечает за надежное и согласованное хранение журналов изменений (edit logs) в распределённой системе с высокой доступностью.

## Основная роль QJM

QJM используется для координации записи изменений файловой системы HDFS между Active и Standby NameNode через распределенные журналирующие узлы (JournalNodes). QJM гарантирует, что все изменения файловой системы надежно записаны и согласованы перед их применением.

## Компоненты QJM

- **JournalNode**: Удалённые узлы, на которых хранится информация об изменениях (edit logs). Обычно для высокой доступности требуется минимум три JournalNodes для обеспечения кворума.
- **Active NameNode**: Основной узел, который инициирует запись изменений в журналы через QJM.
- **Standby NameNode**: Резервный узел, который считывает и применяет изменения из журналов для поддержания актуального состояния файловой системы, синхронизируясь с Active NameNode.

## Принцип работы QJM

1. **Запись изменений (edit logs) Active NameNode**:
   - Когда клиент отправляет запрос на изменение в HDFS (например, создание файла или директории), Active NameNode генерирует запись изменений (edit log).
   - Active NameNode передает эту запись изменения на все JournalNodes через QJM.

2. **Обеспечение согласованности через кворум**:
   - JournalNodes получают запись изменений и сохраняют её локально.
   - Для успешной записи QJM требует, чтобы большинство (кворум) JournalNodes подтвердили получение и успешную запись изменений. При стандартной конфигурации с тремя JournalNodes необходимо подтверждение от как минимум двух узлов.

3. **Применение изменений**:
   - После того как кворум JournalNodes подтвердит запись, Active NameNode считает изменения успешными и применяет их в файловую систему HDFS.
   - Standby NameNode периодически запрашивает у JournalNodes новые изменения и применяет их для синхронизации своего состояния с Active NameNode.

4. **Переключение (failover)**:
   - В случае сбоя Active NameNode, Standby NameNode может стать новым Active NameNode.
   - Новый Active NameNode продолжает работу с последней подтвержденной записью из JournalNodes и продолжает обрабатывать запросы клиентов без потери данных.

## Преимущества QJM

- **Надежность**: Изменения подтверждаются только после того, как кворум JournalNodes сохранит их. Это предотвращает потерю данных при сбоях отдельных узлов.
- **Согласованность**: Использование кворума гарантирует согласованность данных между Active и Standby NameNode.
- **Отказоустойчивость**: В случае сбоя одного или нескольких JournalNodes, система может продолжать работу, если большинство (кворум) узлов продолжает функционировать.

## Пример работы QJM

1. **Запрос клиента**: Клиент отправляет запрос на создание файла в HDFS.
2. **Запись в журналы**: Active NameNode генерирует запись об изменении и передает её на JournalNodes.
3. **Подтверждение кворума**: JournalNodes подтверждают запись, и если большинство узлов завершило запись успешно, Active NameNode завершает операцию.
4. **Синхронизация Standby NameNode**: Standby NameNode запрашивает у JournalNodes новые записи и обновляет своё состояние, чтобы быть готовым к возможному переключению.

