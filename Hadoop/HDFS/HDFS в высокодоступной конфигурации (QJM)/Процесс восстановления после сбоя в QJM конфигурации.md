# Процесс восстановления после сбоя в QJM конфигурации

В случае сбоя в системе **Quorum Journal Manager (QJM)**, которая используется для управления журналами изменений (edit logs) в HDFS, необходимо выполнить восстановление для того, чтобы система вернулась к нормальной работе и обеспечивалась высокая доступность (HA). Восстановление может включать восстановление работы **JournalNode**, синхронизацию между **Active** и **Standby NameNode**, а также проверку целостности данных.

## Этапы восстановления после сбоя в QJM

### 1. **Определение причины сбоя**

Первый шаг — определить, что именно вызвало сбой в конфигурации QJM. Возможные причины:
- Один или несколько **JournalNodes** вышли из строя.
- Проблемы с сетевым подключением между **NameNodes** и **JournalNodes**.
- Проблемы с дисковым пространством на JournalNodes.
  
Необходимо использовать логи и средства мониторинга для точного определения проблемы.

### 2. **Восстановление работоспособности JournalNodes**

Если проблема связана с одним или несколькими **JournalNodes**, необходимо восстановить их работу:

- **Проверка состояния JournalNodes**: Используйте логи системы для анализа состояния всех узлов JournalNodes. Если JournalNode недоступен, перезапустите его службу.
  
- **Перезапуск JournalNode**: Перезапустите сервис на проблемном узле командой:
  ```bash
  hadoop-daemon.sh start journalnode
  ```

- Проверка дискового пространства: Убедитесь, что на каждом JournalNode достаточно свободного места для хранения журналов изменений. Проблемы с диском могут вызвать сбои при записи изменений.
### 3. Синхронизация Standby NameNode с Active NameNode

После восстановления JournalNodes, необходимо убедиться, что Standby NameNode находится в актуальном состоянии и синхронизирован с Active NameNode:

- Проверка состояния Standby NameNode: Убедитесь, что Standby NameNode успешно считывает журналы изменений (edit logs) из JournalNodes и находится в режиме ожидания для переключения в случае необходимости.

- Ручная синхронизация: Если синхронизация была прервана, Standby NameNode должен запросить недостающие изменения с JournalNodes, чтобы восстановить актуальное состояние. Это происходит автоматически, но можно инициировать проверку состояния вручную с помощью команды:

```bash
hdfs haadmin -getServiceState <standby-namenode>
```
### 4. Проверка целостности журналов изменений (edit logs)

После восстановления необходимо убедиться, что журналы изменений (edit logs) целы и доступны для дальнейшего использования. Если целостность журналов была нарушена:

- Использование команд для проверки журналов: Используйте команды для проверки целостности журналов изменений. Например:

```bash
hdfs dfsadmin -saveNamespace
```

- Переход к безопасному режиму (safe mode): В некоторых случаях может потребоваться перевести HDFS в безопасный режим для восстановления:

```bash
hdfs dfsadmin -safemode enter
```

- Чистка и восстановление журналов: Если журналы повреждены, может потребоваться их восстановление или очистка.

### 5. Тестирование процесса failover
После восстановления JournalNodes и синхронизации Standby NameNode с Active NameNode, необходимо протестировать процесс failover, чтобы убедиться, что в случае дальнейшего сбоя система будет переключаться корректно:

- Проверка состояния Zookeeper: Убедитесь, что ZooKeeper корректно отслеживает состояние NameNodes и готов к инициированию процесса failover.

- Ручной failover для тестирования: Выполните тестовый ручной failover для проверки работоспособности:

```bash
hdfs haadmin -failover <active-namenode> <standby-namenode>
```
### 6. Мониторинг системы после восстановления

После завершения всех восстановительных работ важно отслеживать состояние HDFS с помощью инструментов мониторинга, чтобы убедиться, что система работает стабильно:

- Просмотр логов: Проверяйте логи HDFS и JournalNodes для поиска возможных проблем или предупреждений.
- Использование системы мониторинга: Настройте автоматическое оповещение при сбоях JournalNodes или проблемах с синхронизацией NameNodes.
## Заключение
Процесс восстановления после сбоя в QJM конфигурации включает в себя проверку и восстановление JournalNodes, синхронизацию между Active и Standby NameNode, проверку целостности журналов изменений и тестирование failover. После восстановления необходимо следить за системой, чтобы избежать повторных сбоев и обеспечить стабильную работу HDFS.