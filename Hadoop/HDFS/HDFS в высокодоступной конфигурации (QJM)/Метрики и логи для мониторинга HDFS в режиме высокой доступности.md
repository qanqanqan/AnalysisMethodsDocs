# Метрики и логи для мониторинга HDFS в режиме высокой доступности (HA)

Мониторинг HDFS в режиме высокой доступности (HA) требует тщательного отслеживания состояния различных компонентов системы, включая **NameNode**, **DataNode**, **JournalNode** и **ZooKeeper**. Корректный мониторинг помогает быстро выявлять проблемы и обеспечивать стабильную работу кластера.

## 1. **Метрики для мониторинга HDFS HA**

### 1.1. **Метрики NameNode**

**Active и Standby NameNode** — это критические узлы для поддержания высокой доступности, поэтому важно следить за их состоянием и нагрузкой.

- **fsNameSystemState**:
  - Описание: Показывает текущее состояние NameNode (ACTIVE или STANDBY).
  - Назначение: Мониторинг корректного состояния узлов.
  
- **CapacityUsed**:
  - Описание: Количество занятого дискового пространства в HDFS.
  - Назначение: Помогает контролировать использование хранилища и определять, когда необходимо добавлять новые DataNodes.

- **HeapMemoryUsage**:
  - Описание: Использование heap-памяти JVM для NameNode.
  - Назначение: Мониторинг объема используемой памяти и предотвращение переполнения памяти (OutOfMemoryError).

- **EditLogTailerLastSyncTime**:
  - Описание: Время последней синхронизации Standby NameNode с Active NameNode.
  - Назначение: Оценка задержек синхронизации и своевременное выявление проблем с процессом failover.

- **TransactionsSinceLastCheckpoint**:
  - Описание: Количество транзакций с момента последнего контрольного точки (checkpoint).
  - Назначение: Отслеживание необходимости выполнения нового контрольного снимка для предотвращения переполнения журналов изменений.

- **JournalTransactionLag**:
  - Описание: Задержка синхронизации транзакций между Active и Standby NameNode.
  - Назначение: Мониторинг состояния и задержек в синхронизации журналов изменений (edit logs).

### 1.2. **Метрики DataNode**

**DataNode** отвечает за хранение данных и их доступность для клиентов.

- **DatanodeVolumeFailures**:
  - Описание: Количество сбоев на дисках DataNode.
  - Назначение: Раннее обнаружение проблем с аппаратным обеспечением и предотвращение потерь данных.

- **BlocksTotal**:
  - Описание: Общее количество блоков данных, хранящихся на DataNode.
  - Назначение: Контроль количества данных и распределение нагрузки.

- **BlocksReplicated** и **BlocksDeleted**:
  - Описание: Количество блоков, которые были реплицированы или удалены.
  - Назначение: Оценка процесса балансировки данных в кластере и реакция на сбои DataNode.

- **PendingReplicationBlocks**:
  - Описание: Количество блоков, ожидающих репликации.
  - Назначение: Мониторинг состояния репликации блоков данных и выявление проблем с доступностью данных.

- **VolumeUsedPercentage**:
  - Описание: Процент использования дискового пространства на каждом DataNode.
  - Назначение: Помогает избежать перегрузки дисков и эффективно распределить данные между DataNodes.

### 1.3. **Метрики JournalNode**

**JournalNodes** используются для синхронизации журналов изменений (edit logs) между Active и Standby NameNode.

- **JournalSyncs**:
  - Описание: Количество успешных синхронизаций журналов изменений.
  - Назначение: Оценка регулярности и эффективности синхронизации.

- **JournalFailures**:
  - Описание: Количество неудачных попыток синхронизации журналов изменений.
  - Назначение: Предотвращение потерь данных из-за сбоев в JournalNode.

- **JournalDiskUsage**:
  - Описание: Использование дискового пространства на JournalNode.
  - Назначение: Контроль за доступностью дискового пространства для журналов изменений.

### 1.4. **Метрики ZooKeeper**

**ZooKeeper** обеспечивает координацию процессов failover и синхронизации между NameNode.

- **Znode Count**:
  - Описание: Количество узлов данных (znodes) в ZooKeeper.
  - Назначение: Помогает отслеживать количество метаданных, хранимых в ZooKeeper.

- **Session Timeouts**:
  - Описание: Количество тайм-аутов сессий между NameNode и ZooKeeper.
  - Назначение: Обнаружение проблем с сетевым соединением и координацией процессов failover.

- **ZooKeeper Latency**:
  - Описание: Задержка между запросами и ответами в ZooKeeper.
  - Назначение: Оценка производительности ZooKeeper и своевременное реагирование на увеличение задержек.

## 2. **Логи для мониторинга HDFS HA**

### 2.1. **Логи NameNode**

Логи **NameNode** содержат важную информацию о работе системы и состоянии файловой системы.

- **hdfs-audit.log**:
  - Описание: Логи аудита, которые содержат информацию о каждом запросе, выполненном клиентом (чтение, запись, удаление файлов и т.д.).
  - Назначение: Мониторинг активности пользователей и проверка доступа к данным.

- **namenode.log**:
  - Описание: Основной лог NameNode, который содержит информацию о работе NameNode, ошибках, процессах синхронизации и failover.
  - Назначение: Помогает в диагностике проблем с производительностью и синхронизацией между Active и Standby NameNode.

- **failover-controller.log**:
  - Описание: Лог работы контроллера переключения (failover), который содержит информацию о процессе автоматического переключения между Active и Standby NameNode.
  - Назначение: Мониторинг успешности или неудач процесса failover.

### 2.2. **Логи DataNode**

Логи **DataNode** важны для мониторинга операций ввода-вывода и состояния дисков.

- **datanode.log**:
  - Описание: Основной лог DataNode, который содержит информацию о передаче данных между DataNode и клиента, а также между DataNode и NameNode.
  - Назначение: Помогает выявлять проблемы с передачей данных и сбоями дисков.

### 2.3. **Логи JournalNode**

Логи **JournalNode** содержат информацию о процессах синхронизации журналов изменений (edit logs).

- **journalnode.log**:
  - Описание: Лог JournalNode, который фиксирует процесс записи и чтения журналов изменений, а также синхронизацию между Active и Standby NameNode.
  - Назначение: Помогает в диагностике проблем с синхронизацией и хранением журналов.

### 2.4. **Логи ZooKeeper**

Логи **ZooKeeper** содержат информацию о координации и взаимодействии с NameNode.

- **zookeeper.log**:
  - Описание: Лог ZooKeeper, который содержит информацию о сессиях, тайм-аутах и других событиях, связанных с координацией между NameNode.
  - Назначение: Помогает обнаруживать проблемы с соединением и управлением failover.

## 3. **Инструменты мониторинга**

Для удобного мониторинга метрик и логов HDFS можно использовать следующие инструменты:

- **Ambari** или **Cloudera Manager**: Для централизованного мониторинга метрик и логов всех узлов HDFS.
- **Grafana и Prometheus**: Для визуализации метрик HDFS и создания дашбордов.
- **ELK Stack (Elasticsearch, Logstash, Kibana)**: Для агрегации и анализа логов HDFS в реальном времени.

## Заключение

Эффективный мониторинг HDFS в режиме высокой доступности требует отслеживания метрик производительности NameNode, DataNode, JournalNode и ZooKeeper, а также анализа логов, чтобы выявлять и устранять проблемы. Регулярный мониторинг этих параметров позволяет поддерживать высокую производительность и стабильность системы.

