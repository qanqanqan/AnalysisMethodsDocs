
Cost-Based Optimizer (CBO) в Apache Hive — это компонент, который оптимизирует выполнение запросов, выбирая наиболее эффективные планы на основе оценки затрат. 

CBO анализирует различные планы выполнения и выбирает тот, который имеет наименьшую стоимость. CBO необходимо собирать статистику на уровне таблиц и колонок. Это позволяет оценивать предикаты и стоимость плана. Правильная настройка и использование CBO могут значительно сократить время выполнения запросов и улучшить использование ресурсов.

---
## Основные характеристики CBO

1. **Оценка затрат**: CBO анализирует различные планы выполнения и выбирает тот, который имеет наименьшую стоимость. Это может включать в себя такие факторы, как количество обрабатываемых строк, использование ресурсов CPU и I/O.
2. **Использование статистики**: Для эффективной работы CBO необходимо собирать статистику на уровне таблиц и колонок. Это позволяет оценивать предикаты и стоимость плана.
3. **Оптимизация JOIN-операций**: CBO может выполнять переупорядочивание JOIN-операций и удаление ненужных JOIN-ов, что также способствует улучшению производительности.
---

## Как включить CBO

Для активации CBO в Hive необходимо установить несколько параметров:
```sql
SET hive.cbo.enable=true; 
SET hive.stats.fetch.column.stats=true; 
SET hive.stats.fetch.partition.stats=true; 
SET hive.compute.query.using.stats=true;
```
Эти настройки обеспечивают сбор статистики и использование её при оптимизации запросов.

---
## Применение CBO

### 1. Генерация статистики
Перед использованием CBO важно собрать статистику для таблиц:
``` sql
ANALYZE TABLE table_name COMPUTE STATISTICS; 
ANALYZE TABLE table_name COMPUTE STATISTICS FOR COLUMNS column_name;
```

### 2. Объяснение плана выполнения
Для анализа того, как CBO влияет на выполнение запроса, можно использовать команду `EXPLAIN`:
```sql
EXPLAIN SELECT * FROM table_name WHERE condition;
```
Эта команда покажет план выполнения запроса, включая выбранный алгоритм и оценку затрат.

## 3. Примеры использования
CBO особенно полезен для сложных запросов с множественными JOIN-ами и фильтрами. Например:

```sql
SELECT a.*, b.* 
  FROM table_a a 
  JOIN table_b b ON a.id = b.a_id 
 WHERE a.date > '2024-01-01';
```
CBO может оптимизировать порядок JOIN-ов и фильтрацию данных, чтобы минимизировать объем обрабатываемых данных.

---
