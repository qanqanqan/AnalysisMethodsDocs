HBase Master (HMaster) и RegionServer — два ключевых компонента в архитектуре HBase, которые отвечают за управление и обработку данных. Их задачи и роли различаются, но вместе они обеспечивают работу всей системы.

### Роль HMaster:

HMaster — это основной управляющий узел в HBase, который выполняет задачи администрирования и координации, но не участвует напрямую в обработке данных (чтение/запись). Его основные функции:

1. **Управление регионами**:
   - HMaster контролирует процесс создания, слияния и разбиения регионов.
   - Когда размер региона достигает порога, HMaster координирует его разделение на два новых региона, чтобы поддерживать равномерную нагрузку.

2. **Распределение регионов между RegionServers**:
   - HMaster отвечает за назначение регионов на RegionServers при запуске или при сбое одного из серверов.
   - Если RegionServer выходит из строя, HMaster переназначает регионы, которые он обслуживал, другим активным RegionServers.

3. **Мониторинг и управление RegionServers**:
   - HMaster отслеживает состояние всех RegionServers в кластере через ZooKeeper.
   - Если какой-либо RegionServer перестаёт отвечать, HMaster уведомляет об этом и инициирует процесс восстановления данных, которые были на этом сервере.

4. **Метаданные и таблицы**:
   - HMaster управляет метаданными HBase, такими как информация о расположении регионов и таблиц.
   - Он также координирует операции создания, удаления и изменения таблиц.

5. **Обнаружение и восстановление после сбоев**:
   - HMaster через ZooKeeper отслеживает доступность RegionServers и в случае сбоя сервера быстро переназначает его регионы другим серверам.
   - Он также координирует процесс восстановления данных с использованием Write-Ahead Log (WAL).

### Роль RegionServer:

RegionServer — это рабочий узел, который выполняет основную нагрузку по обработке данных в HBase. Он отвечает за хранение данных и выполнение операций чтения и записи. Основные функции RegionServer:

1. **Обслуживание регионов**:
   - RegionServer хранит несколько регионов, каждый из которых представляет собой подмножество данных таблицы, основанное на диапазоне ключей строк.
   - Каждый RegionServer может обслуживать множество регионов, и каждый регион обрабатывается только одним RegionServer в любой момент времени.

2. **Чтение данных**:
   - RegionServer отвечает за выполнение операций чтения данных. Он получает запросы от клиентов, ищет данные в своих регионах и возвращает их клиентам.
   - Данные могут находиться как в памяти (MemStore), так и на диске (HFile в HDFS). Если данные находятся в памяти, операция выполняется быстрее.

3. **Запись данных**:
   - При записи данных RegionServer сначала записывает их в Write-Ahead Log (WAL), а затем в MemStore (буфер в памяти).
   - Когда MemStore заполняется, данные сбрасываются на диск в виде HFile, который хранится в HDFS.

4. **Обработка слияния и разделения регионов**:
   - Когда регион становится слишком большим, RegionServer уведомляет HMaster о необходимости разделения региона.
   - RegionServer также участвует в процессах слияния мелких регионов для повышения эффективности.

5. **Компактация данных**:
   - RegionServer отвечает за выполнение компактации — процесса слияния множества HFiles в один файл для оптимизации чтения данных.
   - Компактация также удаляет устаревшие версии данных и очищает пространство.

6. **Функционирование в условиях сбоя**:
   - При сбое RegionServer его регионы передаются другим RegionServers. Этот процесс координируется HMaster, а данные восстанавливаются с использованием WAL.

### Взаимодействие HMaster и RegionServer:

- **HMaster управляет, RegionServer обрабатывает**: HMaster отвечает за администрирование системы, управление распределением регионов и мониторинг состояния серверов, но сами операции чтения и записи данных обрабатываются RegionServer.
- **Обеспечение отказоустойчивости**: HMaster и RegionServer работают вместе для поддержания системы в случае сбоев. HMaster переназначает регионы, если один из RegionServer выходит из строя.
- **Динамическое распределение нагрузки**: HMaster распределяет регионы между RegionServers так, чтобы нагрузка на сервера была сбалансирована.

### Подведение итогов:

- **HMaster**: Управляет распределением регионов, отслеживает состояние кластера, координирует создание и изменение таблиц, и занимается отказоустойчивостью.
- **RegionServer**: Обрабатывает операции чтения и записи, управляет регионами, хранит данные в HDFS и обрабатывает операции слияния и разделения регионов.

Таким образом, HMaster обеспечивает координацию и управление, а RegionServer выполняет основную работу по взаимодействию с данными в HBase.