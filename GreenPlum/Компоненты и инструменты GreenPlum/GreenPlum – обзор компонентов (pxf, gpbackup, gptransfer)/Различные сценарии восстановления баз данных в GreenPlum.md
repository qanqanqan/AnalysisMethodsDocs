# Различные сценарии восстановления баз данных в GreenPlum
В Greenplum предусмотрено несколько сценариев восстановления баз данных, в зависимости от характера и объема данных, типа сбоя и требований к скорости восстановления. Рассмотрим основные сценарии.

### 1. Полное восстановление базы данных

Этот сценарий используется для восстановления всей базы данных в случае катастрофического сбоя, требующего полной переустановки данных. Полное восстановление может потребоваться, если были повреждены все сегменты или утеряна целая база данных.

**Процесс:**
   - Используйте полную резервную копию, созданную ранее с помощью `gpbackup`.
   - Запустите восстановление всех данных с помощью `gprestore`, указав временную метку и путь к файлам резервной копии:
     ```bash
     gprestore --timestamp <backup_timestamp> --dbname target_database --backup-dir /path/to/backup --jobs 4
     ```
   - После завершения проверьте целостность данных и доступность базы данных.

**Когда использовать**: при необходимости полного восстановления базы данных после серьезного сбоя или потери данных.

### 2. Частичное восстановление (восстановление отдельных таблиц или схем)

Этот сценарий используется, если необходимо восстановить только определенные таблицы или схемы, например, в случае случайного удаления данных или ошибок в части данных.

**Процесс:**
   - Укажите временную метку резервной копии и конкретные таблицы или схемы, которые нужно восстановить.
   - Пример для восстановления отдельной таблицы:
     ```bash
     gprestore --timestamp <backup_timestamp> --dbname target_database --include-table my_schema.my_table --backup-dir /path/to/backup
     ```
   - Пример для восстановления отдельной схемы:
     ```bash
     gprestore --timestamp <backup_timestamp> --dbname target_database --schema my_schema --backup-dir /path/to/backup
     ```

**Когда использовать**: при ошибке, связанной с определенной таблицей или схемой, или необходимости восстановить данные после точечных изменений.

### 3. Восстановление метаданных (схемы, индексов, пользователей)

В некоторых случаях нужно восстановить только метаданные, например, после обновления базы данных или при повреждении схемы, индексов и других вспомогательных объектов.

**Процесс:**
   - Используйте `pg_dump` для резервного копирования метаданных и `pg_restore` для их восстановления.
   - Если метаданные были повреждены, восстановите их с помощью SQL-скрипта:
     ```bash
     pg_restore -d target_database /path/to/metadata_backup.sql
     ```

**Когда использовать**: когда данные не повреждены, но структуры таблиц, индексы или права доступа нуждаются в восстановлении.

### 4. Восстановление после сбоя сегмента

Этот сценарий используется, если вышел из строя один или несколько сегментов. Greenplum может перенаправлять запросы на зеркальные копии сегментов, но поврежденные сегменты нужно восстановить для обеспечения отказоустойчивости.

**Процесс:**
   - Используйте команду `gpstate` для проверки состояния сегментов.
   - Запустите `gprecoverseg` для автоматического восстановления поврежденных сегментов:
     ```bash
     gprecoverseg
     ```
   - После восстановления убедитесь, что все сегменты работают корректно.

**Когда использовать**: если вышел из строя один или несколько сегментов, но зеркальные сегменты продолжают обрабатывать запросы.

### 5. Восстановление с использованием инкрементных резервных копий

Инкрементное восстановление выполняется быстрее, чем полное, так как оно восстанавливает только данные, измененные после последнего резервного копирования.

**Процесс:**
   - Сначала выполните восстановление из последней полной резервной копии.
   - Затем примените инкрементные резервные копии в порядке создания (например, за каждый день).
   - Команда для инкрементного восстановления аналогична полной, но указываются более новые временные метки:
     ```bash
     gprestore --timestamp <incremental_backup_timestamp> --dbname target_database --backup-dir /path/to/backup --jobs 4
     ```

**Когда использовать**: при восстановлении базы данных до последнего актуального состояния без необходимости полного восстановления.

### 6. Восстановление на новую базу данных (клонирование)

Если нужно восстановить данные в новую базу данных или создать клон для тестирования, используйте резервную копию для восстановления в отдельную базу данных.

**Процесс:**
   - Создайте пустую базу данных, в которую будет восстановлен клон.
   - Запустите команду восстановления, указав имя новой базы данных:
     ```bash
     gprestore --timestamp <backup_timestamp> --dbname new_database --backup-dir /path/to/backup --jobs 4
     ```

**Когда использовать**: при создании клона базы данных для тестирования, разработки или анализа.

### 7. Восстановление данных на новый кластер Greenplum

Если требуется восстановить данные на новом кластере, например, после обновления аппаратного обеспечения или переезда на новую инфраструктуру.

**Процесс:**
   - Разверните новый кластер Greenplum.
   - Перенесите файлы резервной копии на новое хранилище кластера.
   - Восстановите данные с помощью команды `gprestore`, как в сценарии полного восстановления:
     ```bash
     gprestore --timestamp <backup_timestamp> --dbname target_database --backup-dir /path/to/backup --jobs 4
     ```

**Когда использовать**: при необходимости переноса данных на новый кластер или восстановления после масштабного сбоя.

---

Эти сценарии охватывают типичные ситуации восстановления данных в Greenplum, позволяя гибко и быстро восстанавливать базу данных в зависимости от уровня отказа.